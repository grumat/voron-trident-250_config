[gcode_macro NOZZLE_WIPE]
description: Cleans the nozzle on the rear silicone wiper pad.
gcode:
	# --- Check for homing and ensure safe Z height ---
	{% if not 'z' in printer.toolhead.homed_axes %}
		G28 Z  ; Ensure Z is homed if not already done
	{% endif %}

	{% set SAFE_Z_HEIGHT = 20.0 %}
	{% set current_z = printer.toolhead.position.z %}

	# Ensure Z is at least at SAFE_Z_HEIGHT (5mm).
	{% if current_z < SAFE_Z_HEIGHT %}
		G0 Z{SAFE_Z_HEIGHT} F600  ; Move Z up to 5mm
	{% endif %}

	# --- Setup and Initial Move ---
	G90                   ; Use Absolute Positioning
	M400                  ; Wait for current moves to finish
	
	{% set X0 = 215 %}
	{% set X1 = 170 %}
	{% set Y0 = 258 %}
	{% set Y1 = 257.2 %}
	{% set Y2 = 256.6 %}
	{% set Z0 = -1.0 %}
	{% set Z1 = -0.8 %}
	{% set Z2 = -0.5 %}
	{% set Z_END = 10 %}
	

	# First we travel to a edge, because a long filament tail forms after long pause in a hot state.
	# This makes sure that this tail is behing the nozzle on an area where no build plate can sustain 
	# this excess. (X250, Y257)
	# The next move ensures this...
	G0 X250 Y257 F6000
	G0 Z{SAFE_Z_HEIGHT} F600
	
	# Fast travel to the start position (X165, Y257)
	G1 X{X0} Y{Y0} Z0.5 F4800

	# --- WIPE PASS 1 (Z=0.3mm) ---
	G0 Z{Z0} F600		; Move Z down to 1.2mm

	{% set WIPE_SPEED = 7200 %} ; 120 mm/s = 7200 mm/min

	# Sequence 1: 165,256 -> 215,255 (50mm X wipe)
	G1 X{X1} Y{Y1} F{WIPE_SPEED} 
	# Sequence 2: 215,255 -> 165,254 (50mm X wipe back)
	G1 X{X0} Y{Y2} Z{Z1} F{WIPE_SPEED}

	# --- WIPE PASS 2 (Z=0.1mm) ---
	M400				; Wait for Z move

	# Repeat the same sequence for the second pass

	# Sequence 1: 165,254 -> 215,255 
	G1 X{X1} Y{Y1} F{WIPE_SPEED} 
	# Sequence 2: 215,255 -> 165,256 
	G1 X{X0} Y{Y0} Z{Z2} F{WIPE_SPEED}

	# --- WIPE PASS 3 (Z=-0.2mm) ---
	M400				; Wait for Z move

	# Sequence 1: 165,256 -> 215,256 (50mm X wipe)
	G1 X{X1} F{WIPE_SPEED} 
	# Sequence 2: 215,256 -> 215,254 (3mm Y move)
	G1 Y{Y2} F{WIPE_SPEED}
	# Sequence 3: 215,254 -> 165,254 (50mm X wipe back)
	G1 X{X0} F{WIPE_SPEED}

	# --- Final Retraction ---
	G0 Z{Z_END} F600	; Move Z up to 10mm
	M400				; Wait for final Z move
